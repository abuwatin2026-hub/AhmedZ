# إصلاح تسجيل الهدر والانتهاء محاسبيًا (تصميم)

## الهدف
- تسجيل الهدر (Wastage) والانتهاء (Expiry) على مستوى المخزن والدفعة (warehouse + batch).
- توليد قيود محاسبية خفيفة تلقائيًا (بدون GL كامل)، مع خرائط حسابات من الإعدادات.
- منع أي أرشفة عامة للصنف بسبب نفاد/انتهاء في مخزن واحد.
- تقارير تدقيقية للهدر والانتهاء قابلة للتصفية زمنيًا وبحسب المخزن والدفعات.

## النطاق
- لا تعديل على منطق التسليم/الخصم الحالي للطلبات.
- يستخدم حركة المخزون `wastage_out` للخصم بسبب الهدر/الانتهاء.
- تعتمد الدُفعات على `batch_id` مع FEFO للأغذية؛ يتم تفريغ الدفعة المنتهية كهدر.

## نموذج البيانات المقترح
- إعادة استخدام جدول `inventory_movements`:
  - `movement_type`: `wastage_out`
  - `item_id`, `quantity`, `unit`, `unit_cost`, `total_cost`, `occurred_at`, `reference_table`, `reference_id`
  - إضافة/التأكيد على وجود: `warehouse_id` و`batch_id` لكل حركة هدر.
- جدول ملخص محاسبي خفيف: `accounting_light_entries`
  - `id`, `entry_type` (`wastage` | `expiry`), `item_id`, `warehouse_id`, `batch_id`, `quantity`, `unit_cost`, `total_cost`, `occurred_at`
  - `debit_account`, `credit_account` مأخوذة من `settings.accounting_accounts` (مثل: `shrinkage` × `inventory`)
  - `created_by`, `created_at`
- ملاحظة: يوجد نوع واجهوي `StockWastage` بالفعل؛ نستخدمه في الواجهة مع الربط بهذه الجداول.

## منطق الهدر والانتهاء
- الهدر اليدوي:
  - واجهة إدخال “هدر” تحدد: الصنف، المخزن، الدفعة، الكمية، سبب، ملاحظات.
  - تنشئ حركة `wastage_out` بالمخزون مع `batch_id` والـ `warehouse_id`.
  - تُسجّل قيد محاسبي خفيف: مدين “نقص المخزون/هدر”، دائن “المخزون”.
- الانتهاء التلقائي:
  - مهمة مجدولة/إجراء: فحص الدُفعات المنتهية، توليد حركة `wastage_out` بكامل المتبقي، وإنشاء قيد محاسبي خفيف.
  - لا تُؤرشف الصنف عالميًا؛ يُصفّر مخزون الدفعة/المخزن فقط.

## قيود محاسبية خفيفة
- استخدام `settings.accounting_accounts`:
  - `shrinkage` (نقص المخزون/هدر) مدين
  - `inventory` (المخزون) دائن
- تخزين القيد في `accounting_light_entries` مع تفاصيل الحركة/التكلفة، بدون دفتر أستاذ كامل.
- تقارير ملخص القيد بحسب فترة ومخزن.

## واجهة المستخدم (اختصارًا)
- شاشة “تسجيل هدر”:
  - اختيار الصنف، المخزن، الدُفعة، إدخال الكمية والسبب.
  - عرض “التكلفة المرجعية” (متوسط/تكلفة الدُفعة).
  - حفظ ⇒ حركة مخزون + قيد محاسبي خفيف + سجل تدقيق.
- شاشة “انتهاء الدُفعات”:
  - قائمة الدُفعات قرب الانتهاء/منتهية مع عوامل تصفية.
  - إجراء “تفريغ كَهدر” للدفعات المنتهية.

## التقارير
- تقرير الانتهاء:
  - جدول: الصنف، المخزن، الدفعة، تاريخ الانتهاء، الكمية المتبقية، إجراء التفريغ.
- تقرير الهدر:
  - جدول: الصنف، المخزن، الدفعة، الكمية، التكلفة، السبب، التاريخ.
- تقرير محاسبي خفيف:
  - مجموع قيود الهدر والانتهاء لكل فترة/مخزن.

## الحوكمة والأمان
- RLS تحكم حسب الدور: فقط من لديه صلاحيات `stock.manage` و`accounting.manage` يسجل هدر.
- سجل تدقيق `system_audit_logs`: `wastage.recorded`، `expiry.processed`.

## ملاحظات تصميمية
- لا أرشفة عامة للصنف: حالة الصنف تظل “نشط” إذا كان متوفرًا في مخازن أخرى؛ يتم إقفاله فقط على مستوى الدُفعة/المخزن.
- التكلفة: استخدام متوسط التكلفة للمخزن أو تكلفة الدُفعة إذا كانت متاحة لضمان دقة `total_cost`.
- الأداء: تنفيذ المهام المجدولة للانتهاء بشكل دفعات، مع حماية من التكرار عبر قيد مرجعي.
