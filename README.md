# ملاحظات وتوجيهات قبل الإنتاج

- إضافة فهارس لقاعدة البيانات لتحسين أداء التقارير على البيانات الكبيرة
- تحديث صلاحيات التخزين وفق Scoped Storage في أندرويد
- إعداد README / أدلة التشغيل
- تحديد سياسة نسخ احتياطي منتظمة

## فهارس قاعدة البيانات

تمت إضافة فهارس لتحسين أداء الاستعلامات الثقيلة في التقارير. تأكد من دفع الهجرات:

```bash
npm run db:push
```

الهجرة: `supabase/migrations/20260111120500_performance_indexes.sql`

## صلاحيات التخزين (Scoped Storage)

- تمت إزالة صلاحيات القراءة/الكتابة العامة للتخزين الخارجي من AndroidManifest والاعتماد على FileProvider وواجهات Capacitor Filesystem.
- في حال الحاجة للوصول إلى وسائط الجهاز على إصدارات حديثة، استخدم Permissions المخصصة (READ_MEDIA_IMAGES/VIDEO/AUDIO) وفق الحاجة داخل الإطار المناسب.

الملف: `android/app/src/main/AndroidManifest.xml`

## أدلة التشغيل

- تطوير:
  - تشغيل: `npm run dev`
  - فحص الأنواع: `npm run typecheck`
- بناء ويب:
  - `npm run build`
- بناء نسخة كاباسيتور ومزامنة أندرويد:
  - `npm run build:capacitor`
  - `npm run sync`
  - فتح المشروع الأصلي: `npm run open`
- معاينة:
  - `npm run preview`
- نشر ملف APK للتحميل:
  - `npm run apk:publish`

## سياسة النسخ الاحتياطي

- الهدف: نسخ احتياطي يومي/أسبوعي للمخطط والبيانات.
- خيار 1 (PostgreSQL قياسي مع pg_dump):
  - متغير اتصال قاعدة البيانات (مثال): `DATABASE_URL=postgres://user:pass@host:5432/db`
  - أمر النسخ الاحتياطي:
    ```bash
    set DATABASE_URL=postgres://user:pass@host:5432/db
    pg_dump --format=custom --file "backups/db_$(date +%F).dump" "%DATABASE_URL%"
    ```
- خيار 2 (Supabase مُدار):
  - استخدم أدوات Supabase الرسمية أو لوحات التحكم لضبط النسخ الاحتياطي التلقائي.
  - يمكن أيضاً جدولة `supabase db pull` أو التصدير حسب السياسات المتاحة.
- التخزين:
  - حفظ النسخ في مجلد `backups/` محلياً مع مزامنة خارجية (S3/Drive).
  - الاحتفاظ بدورة حياة ملفات النسخ (مثلاً آخر 30 نسخة).
- الجدولة:
  - على ويندوز: جدولة مهمة عبر Task Scheduler لتنفيذ أمر النسخ الاحتياطي يومياً.
  - على لينكس: باستخدام `cron`.

## ملاحظات إضافية

- بعد أي تغيير في مخطط قاعدة البيانات، قم بتشغيل اختبارات التوافق إن وجدت.
- راقب الأداء بعد نشر الفهارس، وعدل الفهارس عند توسع البيانات أو تغير أنماط الاستعلام.
