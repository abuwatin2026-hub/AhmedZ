# تقرير فحص شامل لنظام مبيعات ومخزون ومحاسبة (ERP Audit)

**التاريخ:** 2026-01-31  
**النطاق:** دورة حياة الصنف، المخازن، الحجوزات، المبيعات، المشتريات، المحاسبة، الدفعات، التقارير، قاعدة البيانات، المعاملات والتزامن.

---

## الملخص التنفيذي

تم فحص النظام وفق البرومبت المطلوب. التصميم الحالي يربط **تأكيد التسليم** مع **خصم المخزون** عبر RPC ذري (`confirm_order_delivery` → `deduct_stock_on_delivery_v2`) ويوجد trigger يمنع وضع الطلب `delivered` دون وجود حركات `sale_out`. مع ذلك، وُجدت أسباب هيكلية وتشغيلية تفسر ظهور أعراض "البيع يُسجّل في التقارير والمخزون لا يتغير"، وأخطاء مصنّفة (حرجة / متوسطة / تحسين) مع أسباب جذرية وحلول مقترحة.

---

## 1. دورة حياة الصنف (Item Lifecycle)

### المسار الفعلي في الكود

| المرحلة | الآلية | الملاحظات |
|--------|--------|-----------|
| الشراء | `receive_purchase_order_partial` | يضيف كميات، ينشئ/يحدّث دفعات (batches)، يحدّث `stock_management` و`inventory_movements` (purchase_in). |
| الإدخال للمخزون | نفس الاستلام + `post_inventory_movement` | التكلفة تُربط بالدفعة و`order_item_cogs` لاحقاً عند البيع. |
| النقل بين المخازن | `warehouse_transfers` + إكمال النقل (RPC) | حركات نقل وربط بدفعات عند الحاجة. |
| الحجز | `reserve_stock_for_order` | للطلبات غير الحاضرة (pending)؛ البيع الحضوري الفوري **لا** يستدعي حجزاً. |
| البيع | `confirm_order_delivery` → `deduct_stock_on_delivery_v2` | خصم من دفعات (FEFO)، تحديث `stock_management`، إدراج `inventory_movements` (sale_out). |
| الإرجاع | `process_sales_return` | حركات وإعادة إلى المخزون. |
| التسوية | `manage_menu_item_stock` / تعديل يدوي | تحديث كميات وربط بدفعات. |
| الإقفال المحاسبي | فترات محاسبية + قفل القيود | منع ترحيل في فترات مقفلة. |

**الخلل المحتمل في الدورة:** الاعتماد الكامل على وجود **دفعات (batches)** للصنف في الخصم. إذا لم يكن للصنف أي دفعة (مثلاً صنف غير غذائي أو لم يُستلم أبداً عبر أمر شراء)، فإن `deduct_stock_on_delivery_v2` يرفع استثناء "Insufficient batch stock" ولا يُنشئ حركات، وبالتالي لا يُحدّث `stock_management` ولا يُمرّر trigger الطلب.

---

## 2. نظام المخازن (Inventory System)

### ما تم فحصه

- **تعدد المخازن:** مدعوم عبر `warehouses` و`stock_management` و`session_scope.warehouseId`. عمليات الحجز والخصم تتطلب `p_warehouse_id`.
- **On Hand / Reserved / Available:** `stock_management` (available_quantity, reserved_quantity)؛ الـ available يُفترض أنه المعبّر عنه بعد احتساب المحجوز.
- **حركات المخزون:** جدول `inventory_movements` مع ربط بـ orders/batches/warehouse؛ ترحيل محاسبي عبر `post_inventory_movement`.
- **Trigger منع التسليم دون حركات:** `trg_orders_require_sale_out_on_delivered` يمنع `status = 'delivered'` إذا لم توجد حركة `sale_out` للطلب.

### أخطاء مكتشفة

| # | الخطأ | التصنيف | السبب الجذري | الأثر |
|---|-------|----------|---------------|-------|
| 2.1 | أصناف بدون دفعات (batches) لا يُخصم لها مخزون | **حرج** | `deduct_stock_on_delivery_v2` يخصم فقط من جدول `batches`. إذا لم يكن للصنف أي صف في `batches`، الحلقة لا تُنفّذ ويُرفع استثناء "Insufficient batch stock". | الطلب لا يُسلّم، أو في مسارات قديمة/مختلفة قد يظهر "بيع" في واجهة دون حركة مخزون. |
| 2.2 | Trigger الطلب لا يتحقق من المستودع | **تحسين** | `trg_orders_require_sale_out_on_delivered` يتحقق فقط من وجود حركة `sale_out` للطلب دون ربطها بـ `warehouse_id`. نظرياً يمكن وجود حركة لمستودع آخر. | احتمال تناقض نادر بين مستودع الطلب ومستودع الحركة. |

---

## 3. الحجوزات (Reservations)

### متى تُنشأ وتُلغى

- **الإنشاء:** عند إنشاء طلب **معلق** (بدون دفع فوري) من الإدارة يُستدعى `reserve_stock_for_order` بعد إدراج الطلب.
- **التحويل إلى خصم:** عند تأكيد التسليم يُستدعى أولاً `release_reserved_stock_for_order` (لطلبات in_store) ثم `confirm_order_delivery` الذي ينفّذ `deduct_stock_on_delivery_v2`.
- **البيع الحضوري الفوري:** لا يُستدعى حجز؛ يُستدعى مباشرة `confirm_order_delivery_with_credit` أو `confirm_order_delivery`.

### أخطاء مكتشفة

| # | الخطأ | التصنيف | السبب الجذري | الأثر |
|---|-------|----------|---------------|-------|
| 3.1 | مسار البيع الفوري بلا حجز | **متوسط** | بالتصميم الحالي لا حجز للبيع الحضوري المدفوع فوراً. الخصم يعتمد على توفر الكمية في `stock_management` ووجود دفعات. في حال التزامن العالي قد يُقدّم طلبان على نفس الكمية. | احتمال "بيع أكثر من المتاح" إذا لم تُستخدم قفل صفّي أو تحقق صارم في نفس اللحظة. |
| 3.2 | تقرير الحجوزات ومصدر الحقيقة | **تحسين** | وجود `reservation_ledger` و`batch_reservations` و`stock_management.reserved_quantity` يوجب وضوحاً لمصدر تقرير "الحجوزات المفتوحة". | خطر تضارب إذا اعتمد تقرير على مصدر مختلف عن منطق الخصم. |

---

## 4. المبيعات (Sales)

### المسار المُفحوص

1. **إنشاء أمر البيع (حضوري):** `createInStoreSale` → `createRemoteOrder({ ...newOrder, status: 'pending' })` ثم عند وجود صلاحية دفع فوري: `rpcConfirmOrderDeliveryWithCredit` أو `rpcConfirmOrderDelivery`.
2. **تأكيد التسليم:** نفس الـ RPC تستدعي `confirm_order_delivery` التي تنفّذ `deduct_stock_on_delivery_v2` ثم تحديث `orders.status = 'delivered'`.
3. **الحسابات المحاسبية:** تُنفّذ عبر `post_inventory_movement` ومسارات الإيراد/COGS المرتبطة.

### أخطاء مكتشفة

| # | الخطأ | التصنيف | السبب الجذري | الأثر |
|---|-------|----------|---------------|-------|
| 4.1 | فشل التأكيد يحذف الطلب ولا يحدّث الواجهة دائماً | **متوسط** | عند فشل `rpcConfirmOrderDeliveryWithCredit` يتم حذف الطلب من DB ورمي استثناء. إذا التقطت الواجهة الخطأ وعرضت رسالة غير واضحة، قد يظن المستخدم أن البيع "تم" بينما الطلب مُحذف. | ارتباك للمستخدم وربما إعادة بيع نفس الصنف. |
| 4.2 | صيغة `p_items` والـ fallback على `order.data` | **تحسين** | إذا وصلت `p_items` فارغة أو بتسمية خاطئة، الـ RPC تعتمد على `_extract_stock_items_from_order_data(v_order_data)`. بنية `order.data` (مثلاً items vs invoiceSnapshot) قد تختلف حسب مسار الإنشاء. | احتمال استخراج قائمة أصناف خاطئة أو ناقصة عند التأكيد. |

---

## 5. المشتريات (Purchases)

- أوامر الشراء، الاستلام الجزئي/الكامل، إضافة الكميات للمخزون والدفعات، وتكلفة الصنف موثّقة في المهاجرات (مثل `receive_purchase_order_partial`، `post_inventory_movement`، ربط الدفعات بـ purchase_orders).
- لم يُكتشف خلل حرج يمنع إضافة المخزون أو ربط التكلفة؛ التهديد الأكبر يبقى في جانب البيع/الخصم (أصناف بدون دفعات).

---

## 6. المحاسبة (Accounting)

- الربط بين المخزون والمبيعات والمشتريات والدفعات موجود عبر `post_inventory_movement`، `post_payment`، ومسارات الإيراد/COGS.
- دوال الترحيل محصورة بصلاحيات (مثل accounting.manage) وـ FORCE RLS على الجداول المحاسبية.
- **خلل محتمل:** إذا لم تُنشأ حركة مخزون للبيع (بسبب خطأ 2.1 أو مسار استثنائي)، لن يُسجّل قيد COGS مطابق للواقع، مما يخلّ بتقييم المخزون والإيراد.

---

## 7. الدفعات (Payments)

- دفعات العملاء: `record_order_payment`؛ دفعات الموردين: `record_purchase_order_payment` مع مزامنة `paid_amount`.
- لا تُغلق مستندات دون تحقق من الطرف الآخر (مثلاً COD لا يُضبط paidAt إلا بعد التسوية). لم يُرصد خلل يربط الدفعات "فقط بالمبيعات دون تحقق المخزون" من ناحية المنطق؛ الخلل يكون عندما يُسجّل بيع (delivered) دون حركة مخزون (انظر 2.1).

---

## 8. التقارير (Reports)

### مصدر البيانات

- **تقارير المنتجات (ProductReports):**  
  - **كميات مبيعة (quantity_sold، إجماليات):** من RPC `get_product_sales_report_v9` الذي يبني النتائج من جدول **orders** (status = 'delivered') ويوسّع الأصناف من `data.invoiceSnapshot.items` أو `data.items`.  
  - **المخزون الحالي (current_stock، reserved_stock، current_cost_price):** تُستبدل في الواجهة من استعلام منفصل على **stock_management** حسب `sessionScope.warehouseId`.  
  - أي **تجميع للبيانات** يجمع مصدرين: مبيعات من **orders** ومخزون من **stock_management**.

### أخطاء مكتشفة

| # | الخطأ | التصنيف | السبب الجذري | الأثر |
|---|-------|----------|---------------|-------|
| 8.1 | غياب "مصدر حقيقة واحد" للتقارير | **حرج** | تقرير المنتجات يعتمد على **orders** للمبيعات و**stock_management** للمخزون. إذا لم يُنفّذ الخصم (مثلاً فشل deduct أو مسار قديم)، الطلب يبقى delivered في واجهة/كاش بينما الـ DB قد لا تحتوي حركات، أو العكس: حركات ناقصة والمخزون لم يُحدّث. النتيجة: التقرير يظهر "بيع" والمخزون يظهر "بدون تغيير". | تضارب بين التقارير والواقع الفعلي للمخزون، وأخطاء محاسبية محتملة. |
| 8.2 | المخزون في التقرير حسب مستودع الجلسة فقط | **متوسط** | تقرير المنتجات يدمج مخزون من استعلام بـ `warehouse_id = sessionScope.warehouseId`. إذا كان التقرير يعرض مبيعات كل المناطق أو كل المستودعات بينما المخزون لمستودع واحد، النتيجة غير متسقة. | أرقام مخزون لا تطابق نطاق المبيعات المعروض. |

---

## 9. قاعدة البيانات (Database Audit)

- الجداول الرئيسية للمخزون والطلبات والحجوزات والحركات والدفعات والقيود موثّقة في المهاجرات.
- القيود والـ triggers (مثل منع delivered دون sale_out، قفل الفترات المحاسبية) موجودة.
- **RPC:** توقيعات موحّدة (مثلاً أغلفة `p_payload`) مع وجود توقيعات مباشرة (مثل confirm_order_delivery(uuid, jsonb, jsonb, uuid)) للتوافق مع الواجهة.

### أخطاء مكتشفة

| # | الخطأ | التصنيف | السبب الجذري | الأثر |
|---|-------|----------|---------------|-------|
| 9.1 | منطق الخصم يعتمد بالكامل على وجود دفعات | **حرج** | عدم وجود مسار "خصم بدون دفعة" (مثلاً لأصناف غير مرتبطة بـ batches) يمنع إتمام البيع لأصناف لها رصيد في `stock_management` فقط. | عدم خصم مخزون فعلي رغم تسجيل البيع في واجهة أو تقارير تعتمد على orders. |
| 9.2 | تعدد توقيعات RPC ونمط الواجهة | **تحسين** | الواجهة تجرب wrapper ثم direct؛ أي تغيير في التوقيعات أو إسقاط توقيع قد يسبب 404 أو سلوك غير متوقع. | ضرورة الحفاظ على توافق التوقيعات مع الواجهة. |

---

## 10. المعاملات والتزامن (Transactions & Concurrency)

- عمليات مثل `confirm_order_delivery` و`deduct_stock_on_delivery_v2` تُنفّذ في إجراء واحد وتستخدم قفل صفّي (FOR UPDATE) على `stock_management` و`batches`.
- **Race conditions:** احتمال نظري عند بيع حضوري فوري متزامن لنفس الصنف دون حجز مسبق (انظر 3.1).

---

## تصنيف الأخطاء والحلول المقترحة

### حرجة

1. **أصناف بدون دفعات لا يُخصم لها مخزون (2.1 / 9.1)**  
   - **الحل:** إضافة مسار في `deduct_stock_on_delivery_v2` للأصناف التي لا تحتوي على صفوف في `batches` (أو صنف غير غذائي/بدون تتبع دفعات): خصم من `stock_management` فقط وإنشاء حركة `sale_out` مع `batch_id = null` إن كان مسموحاً بالـ schema، أو إنشاء "دفعة افتراضية" واحدة لكل صنف/مستودع عند أول إضافة مخزون.
2. **تقارير المنتجات: مصدران للمعطى (8.1)**  
   - **الحل:** جعل تقرير المنتجات يعتمد على **حركات المخزون** (inventory_movements مع movement_type = 'sale_out') كمصدر لـ quantity_sold والإجماليات، مع الاحتفاظ بـ orders للتفاصيل (عميل، تاريخ، فاتورة). أو على الأقل: عرض تحذير إذا كان مجموع المبيعات من الطلبات لا يطابق مجموع حركات sale_out للفترة، وإظهار "مخزون" من نفس مصدر الحركات (مثلاً من stock_management المحدّث فقط عند وجود حركات).

### متوسطة

3. **فشل تأكيد التسليم وحذف الطلب (4.1):** تحسين رسائل الواجهة وإظهار "لم يتم تنفيذ البيع – تم التراجع عن الطلب" مع إعادة تحميل القائمة.  
4. **البيع الفوري بلا حجز (3.1):** إما استدعاء حجز قصير الأمد قبل التأكيد للبيع الحضوري، أو تشديد التحقق داخل `deduct_stock_on_delivery_v2` مع قفل صفّي كافٍ.  
5. **نطاق المستودع في تقرير المنتجات (8.2):** توحيد النطاق (مثلاً فلترة الطلبات والحركات بنفس warehouse_id أو إظهار المخزون لكل مستودع بشكل منفصل).

### تحسين

6. **Trigger الطلب والمستودع (2.2):** إضافة شرط في الـ trigger أن تكون حركة sale_out مرتبطة بنفس مستودع الطلب إن وُجد warehouse_id في الطلب.  
7. **صيغة p_items والـ fallback (4.2):** توثيق بنية `order.data` و`_extract_stock_items_from_order_data` واختبارات تلقائية لسيناريوهات items فقط / invoiceSnapshot فقط.  
8. **توقيعات RPC (9.2):** توثيق التوقيع المعتمد رسمياً للواجهة والاحتفاظ بفترة انتقالية عند أي تغيير.

---

## تصميم مقترح لنظام ERP مستقر (Single Source of Truth)

1. **مصدر الحقيقة للمخزون:**  
   - **حركات المخزون (inventory_movements)** هي السجل المعياري لكل زيادة ونقصان.  
   - **stock_management** يُعتبر **مجموعاً محسوباً** (أو يُحدّث ذرياً فقط من خلال RPC واحدة مبنية على الحركات).  
   - لا يعتمد أي تقرير "مبيعات/مخزون" على orders فقط دون التوفيق مع الحركات.

2. **تسلسل البيع:**  
   - إنشاء الطلب (orders) → حجز اختياري حسب نوع البيع → **تأكيد التسليم = خصم مخزون (حركات + تحديث stock) في نفس المعاملة** → تحديث status.  
   - منع أي مسار يضع الطلب delivered دون إنشاء حركات sale_out (الـ trigger الحالي يدعم ذلك؛ يُستكمَل بمسار خصم لغير الدفعات إن لزم).

3. **التقارير:**  
   - **كميات مبيعة وتكاليف:** من `inventory_movements` (sale_out) مع ربط بالطلبات للتفاصيل.  
   - **المخزون المتاح:** من `stock_management` مع إمكانية مقارنة مع مجموع الحركات للتحقق.  
   - تنبيه أو كشف تلقائي عند اختلاف بين مجموع المبيعات من الطلبات ومجموع حركات sale_out للفترة نفسها.

4. **الأصناف بدون دفعات:**  
   -要么 دعم خصم مباشر من stock_management مع حركة sale_out بدون batch_id (إن كان الـ schema يدعمه)، أو ضمان إنشاء "دفعة افتراضية" عند أول استلام/تسوية لكل صنف/مستودع حتى يبقى منطق الخصم موحّداً على الدفعات.

---

## ملخص تنفيذي نهائي

- **السبب الجذري الأقوى لأعراض "البيع يظهر والمخزون لا يتغير":**  
  1) **غياب مصدر حقيقة واحد** – التقارير تعتمد على orders للمبيعات وstock_management للمخزون دون ربط إلزامي بحركات المخزون.  
  2) **أصناف بدون دفعات** – عدم وجود مسار خصم لها يمنع إنشاء حركات sale_out وتحديث stock_management رغم احتمال ظهور الطلب كـ "مسلّم" في واجهة أو كاش.  

- **الإجراءات ذات الأولوية:**  
  - تنفيذ مسار خصم (أو دفعة افتراضية) للأصناف بدون دفعات.  
  - جعل تقارير المنتجات/المخزون تعتمد على حركات المخزون كمصدر للمبيعات مع الاحتفاظ بالطلبات للتفاصيل، وإضافة تحقق من اتساق الطلبات مع الحركات.

تم إعداد هذا التقرير بناءً على فحص الكود والمهاجرات والـ RPC والواجهة دون تشغيل بيئة حية؛ يُوصى باختبار التغييرات في بيئة تشبه الإنتاج والتحقق من البيانات الحالية لأي طلبات delivered بدون حركات sale_out أو أصناف لها رصيد بدون دفعات.

---

## الإصلاحات المطبّقة (2026-01-31)

| الملف / المهاجرة | الإصلاح |
|------------------|---------|
| `supabase/migrations/20260131230000_erp_audit_fix_deduct_and_trigger.sql` | 1) **خصم أصناف بدون دفعات:** عند عدم وجود أي دفعة ذات رصيد للصنف/المستودع، يتم الخصم من `stock_management` فقط وإنشاء حركة `sale_out` مع `batch_id = null`. 2) **Trigger الطلب:** ربط التحقق من حركات التسليم بمستودع الطلب (`data->>warehouseId`) عند التوفره. |
| `supabase/migrations/20260131231000_erp_audit_report_from_movements.sql` | **مصدر حقيقة للكميات:** إضافة RPC `get_product_sales_quantity_from_movements` التي تُرجع الكمية المباعة من جدول `inventory_movements` (sale_out) فقط. |
| `screens/admin/reports/ProductReports.tsx` | دمج كميات المبيعات من الحركات مع تقرير v9: عند توفر نتيجة من `get_product_sales_quantity_from_movements` تُستخدم كمصدر لـ `quantity_sold` مع إظهار ملاحظة "الكميات المباعة من حركات المخزون (مصدر موحّد)". |
| `contexts/OrderContext.tsx` | تحسين رسالة الخطأ عند فشل تأكيد البيع الحضوري: "لم يتم تنفيذ البيع. تم التراجع عن الطلب. السبب: ..." لتفادي التباس المستخدم. |
